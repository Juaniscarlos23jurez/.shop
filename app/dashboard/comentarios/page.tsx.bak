              {mergedStats.average_rating?.toFixed(1) ?? "0.0"}
              <Star className="h-5 w-5 text-amber-400" />
            </CardTitle>
          </CardHeader>
          <CardContent className="text-sm text-slate-500">
            Basado en {mergedStats.total} reseñas
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-2">
            <p className="text-sm text-slate-500">Tiempo de respuesta</p>
            <CardTitle className="text-3xl font-bold">
              {mergedStats.pending === 0 && mergedStats.total > 0
                ? "100%"
                : mergedStats.total
                ? `${Math.round(((mergedStats.total - mergedStats.pending) / mergedStats.total) * 100)}%`
                : "0%"}
            </CardTitle>
          </CardHeader>
          <CardContent className="text-sm text-slate-500">
            {mergedStats.total - mergedStats.pending} comentarios respondidos
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-2 flex-row items-center justify-between">
            <div>
              <p className="text-sm text-slate-500">Origen App</p>
              <CardTitle className="text-3xl font-bold">{mobileBreakdown}</CardTitle>
            </div>
            <div className="rounded-full bg-slate-100 p-2">
              <Smartphone className="h-4 w-4 text-slate-600" />
            </div>
          </CardHeader>
          <CardContent className="text-sm text-slate-500">
            {Math.round((mobileBreakdown / (reviews.length || 1)) * 100) || 0}% del total
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-2 flex-row items-center justify-between">
            <div>
              <p className="text-sm text-slate-500">Origen Web</p>
              <CardTitle className="text-3xl font-bold">{webBreakdown}</CardTitle>
            </div>
            <div className="rounded-full bg-slate-100 p-2">
              <Globe className="h-4 w-4 text-slate-600" />
            </div>
          </CardHeader>
          <CardContent className="text-sm text-slate-500">
            {Math.round((webBreakdown / (reviews.length || 1)) * 100) || 0}% del total
          </CardContent>
        </Card>
      </section>

      <Card className="border-0 shadow-none bg-white/80 backdrop-blur">
        <CardContent className="p-4 md:p-6">
          <div className="flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between">
            <div className="grid gap-3 sm:grid-cols-2 lg:grid-cols-4 flex-1">
              <div className="space-y-2">
                <p className="text-xs uppercase tracking-wide text-slate-500">Buscar</p>
                <Input
                  placeholder="Usuario, comentario, etiqueta"
                  value={search}
                  onChange={(e) => setSearch(e.target.value)}
                  className="h-11"
                />
              </div>
              <div className="space-y-2">
                <p className="text-xs uppercase tracking-wide text-slate-500">Canal</p>
                <Select value={channelFilter} onValueChange={(value) => setChannelFilter(value as any)}>
                  <SelectTrigger className="h-11">
                    <SelectValue placeholder="Canal" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">Todos</SelectItem>
                    <SelectItem value="app">App</SelectItem>
                    <SelectItem value="web">Web</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div className="space-y-2">
                <p className="text-xs uppercase tracking-wide text-slate-500">Estado</p>
                <Select value={statusFilter} onValueChange={(value) => setStatusFilter(value as any)}>
                  <SelectTrigger className="h-11">
                    <SelectValue placeholder="Estado" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">Todos</SelectItem>
                    <SelectItem value="responded">Respondidos</SelectItem>
                    <SelectItem value="pending">Pendientes</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div className="space-y-2">
                <p className="text-xs uppercase tracking-wide text-slate-500">Rating</p>
                <Select value={ratingFilter} onValueChange={(value) => setRatingFilter(value as any)}>
                  <SelectTrigger className="h-11">
                    <SelectValue placeholder="Rating" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">Todos</SelectItem>
                    <SelectItem value="5">5 estrellas</SelectItem>
                    <SelectItem value="4">4 estrellas</SelectItem>
                    <SelectItem value="3">3 estrellas</SelectItem>
                    <SelectItem value="2">2 estrellas o menos</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
            <div className="flex flex-wrap gap-3">
              <Select value={sortOption} onValueChange={(value) => setSortOption(value as any)}>
                <SelectTrigger className="h-11 w-44">
                  <SelectValue placeholder="Ordenar" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="recent">Más recientes</SelectItem>
                  <SelectItem value="rating-desc">Mejor calificados</SelectItem>
                  <SelectItem value="rating-asc">Menor calificados</SelectItem>
                </SelectContent>
              </Select>
              <Button variant="outline" className="h-11 gap-2">
                <Filter className="h-4 w-4" />
                Filtros avanzados
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>

      {!hasAccess && (
        <Card className="border-dashed border-slate-300 bg-slate-50">
          <CardContent className="py-8 text-center text-slate-600">
            Conecta una compañía para administrar los comentarios de tus clientes.
          </CardContent>
        </Card>
      )}

      {error && (
        <Card className="border-rose-200 bg-rose-50 text-rose-700">
          <CardContent className="py-6">
            {error}
          </CardContent>
        </Card>
      )}

      <div className="grid gap-6 lg:grid-cols-[2fr_1fr]">
        <Card className="bg-white shadow-lg/30 border-slate-100">
          <CardHeader className="pb-3">
            <CardTitle className="flex items-center gap-3">
              <MessageCircle className="h-5 w-5 text-violet-600" />
              Conversaciones recientes
            </CardTitle>
            <p className="text-sm text-slate-500">
              {filteredComments.length} resultados · Última actualización {new Date().toLocaleTimeString("es-MX")}
            </p>
          </CardHeader>
          <CardContent className="space-y-4">
            {isLoading && (
              <div className="rounded-2xl border border-dashed border-slate-200 p-8 text-center flex flex-col items-center gap-3">
                <Loader2 className="h-6 w-6 animate-spin text-violet-500" />
                <p className="text-sm text-slate-500">Sincronizando reseñas...</p>
              </div>
            )}
            {!isLoading && filteredComments.length === 0 && (
              <div className="rounded-2xl border border-dashed border-slate-200 p-8 text-center">
                <p className="text-lg font-semibold text-slate-700">
                  No hay comentarios con los filtros seleccionados
                </p>
                <p className="text-sm text-slate-500 mt-2">
                  Ajusta los filtros o exporta el historial completo para analizar tendencias.
                </p>
              </div>
            )}

            {filteredComments.map((comment) => (
              <div
                key={comment.id}
                className="rounded-2xl border border-slate-100 bg-white p-5 shadow-sm hover:shadow-md transition-all"
              >
                <div className="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
                  <div className="space-y-3">
                    <div className="flex flex-wrap items-center gap-2">
                      <div className="flex items-center gap-2">
                        <div className="h-10 w-10 rounded-full bg-gradient-to-br from-violet-200 to-violet-100 text-violet-700 flex items-center justify-center font-semibold">
                          {comment.userName
                            .split(" ")
                            .map((word) => word[0])
                            .slice(0, 2)
                            .join("")}
                        </div>
                        <div>
                          <p className="font-semibold text-slate-900">{comment.userName}</p>
                          <p className="text-xs text-slate-500">
                            {comment.userRole} · {comment.userHandle}
                          </p>
                        </div>
                      </div>
                      <Badge
                        variant="outline"
                        className={cn(
                          "capitalize border rounded-full px-3 py-1 text-xs flex items-center gap-1",
                          channelKey === "app" ? "border-violet-200 text-violet-700" : "border-slate-200 text-slate-600"
                        )}
                      >
                        <channelInfo.icon className="h-3 w-3" />
                        {channelInfo.label}
                      </Badge>
                      <Badge
                        variant="outline"
                        className={cn("rounded-full px-3 py-1 text-xs", statusColors[comment.status])}
                      >
                        {comment.status === "approved"
                          ? "Aprobado"
                          : comment.status === "pending"
                          ? "Pendiente"
                          : "Rechazado"}
                      </Badge>
                    </div>

                    <p className="text-slate-700 text-base leading-relaxed">{comment.comment}</p>

                    <div className="flex flex-wrap items-center gap-2">
                      {(comment.tags || []).map((tag) => (
                        <Badge key={tag} variant="secondary" className="rounded-full bg-slate-100 text-slate-700">
                          #{tag}
                        </Badge>
                      ))}
                    </div>

                    <div className="flex flex-wrap gap-4 text-sm text-slate-500">
                      <span className="flex items-center gap-1">
                        <Clock4 className="h-4 w-4" />
                        {new Date(comment.created_at).toLocaleString("es-MX", {
                          dateStyle: "medium",
                          timeStyle: "short",
                        })}
                      </span>
                      <span className="flex items-center gap-1">
                        <MapPin className="h-4 w-4" />
                        {comment.location || "Ubicación desconocida"}
                      </span>
                      <span>{comment.platform || "—"}</span>
                    </div>
                  </div>

                  <div className="flex flex-col items-start gap-3 min-w-[220px]">
                    <div className="flex items-center gap-1 text-amber-500">
                      {Array.from({ length: 5 }).map((_, index) => {
                        const ratingValue = Number(comment.rating || 0);
                        const filled = ratingValue >= index + 1;
                        const half = !filled && ratingValue > index && ratingValue < index + 1;
                        if (filled) return <Star key={index} className="h-4 w-4 fill-current" />;
                        if (half) return <StarHalf key={index} className="h-4 w-4 fill-current" />;
                        return <Star key={index} className="h-4 w-4" />;
                      })}
                    </div>
                    <Badge
                      variant="outline"
                      className={cn("rounded-full px-3 py-1 text-xs font-semibold", statusColors[comment.status])}
                    >
                      {comment.status === "approved"
                        ? "Aprobado"
                        : comment.status === "pending"
                        ? "Pendiente"
                        : "Rechazado"}
                    </Badge>
                    <Select
                      value={comment.status}
                      onValueChange={(value) => handleStatusUpdate(comment.id, value as ReviewStatus)}
                      disabled={statusUpdatingId === comment.id}
                    >
                      <SelectTrigger className="h-9 w-full">
                        <SelectValue placeholder="Estado" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="approved">Aprobado</SelectItem>
                        <SelectItem value="pending">Pendiente</SelectItem>
                        <SelectItem value="rejected">Rechazado</SelectItem>
                      </SelectContent>
                    </Select>
                    <Button
                      variant="outline"
                      className="w-full gap-2"
                      size="sm"
                      onClick={() => openResponseDialog(comment)}
                      disabled={!hasAccess}
                    >
                      <Reply className="h-4 w-4" />
                      {comment.response ? "Editar respuesta" : "Responder ahora"}
                    </Button>
                    {comment.response && (
                      <div className="w-full rounded-xl border border-slate-100 bg-slate-50 px-3 py-2 text-xs text-slate-600">
                        <p className="font-semibold text-slate-700">Respuesta del equipo</p>
                        <p className="mt-1">{comment.response}</p>
                        <p className="mt-1 text-[11px] text-slate-500">
                          {comment.responded_at
                            ? new Date(comment.responded_at).toLocaleString("es-MX", {
                                dateStyle: "medium",
                                timeStyle: "short",
                              })
                            : "hace un momento"}
                        </p>
                      </div>
                    )}
                  </div>
                </div>
              );
            })}
          </CardContent>
        </Card>

        <div className="space-y-6">
          <Card className="border-violet-100 bg-gradient-to-b from-white to-violet-50">
            <CardHeader className="pb-2">
              <CardTitle className="text-base text-slate-800 flex items-center gap-2">
                <TrendingUp className="h-4 w-4 text-violet-600" />
                Insights accionables
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="rounded-xl border border-violet-100 bg-white p-4">
                <p className="text-sm font-semibold text-slate-800">Checkout con fricción</p>
                <p className="text-sm text-slate-500 mt-1">
                  32% de los comentarios web mencionan formularios extensos. Automatiza el autocompletado
                  con datos guardados para mejorar conversión.
                </p>
              </div>
              <div className="rounded-xl border border-violet-100 bg-white p-4">
                <p className="text-sm font-semibold text-slate-800">Notificaciones nocturnas</p>
                <p className="text-sm text-slate-500 mt-1">
                  Ajusta la ventana de envíos push entre 8am y 9pm para mejorar la percepción en Android.
                </p>
              </div>
              <div className="rounded-xl border border-violet-100 bg-white p-4">
                <p className="text-sm font-semibold text-slate-800">Soporte proactivo</p>
                <p className="text-sm text-slate-500 mt-1">
                  Crea respuestas automáticas cuando el chat no esté disponible y ofrece CTA directo a WhatsApp.
                </p>
              </div>
            </CardContent>
          </Card>
          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-base text-slate-800">Distribución por sentimiento</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              {([
                { key: "approved", label: "Aprobados", color: "bg-emerald-400" },
                { key: "pending", label: "Pendientes", color: "bg-amber-400" },
                { key: "rejected", label: "Rechazados", color: "bg-rose-400" },
              ] as const).map((entry) => {
                const count = reviews.filter((c) => c.status === entry.key).length;
                const percentage = Math.round((count / (reviews.length || 1)) * 100) || 0;
                return (
                  <div key={entry.key} className="space-y-1">
                    <div className="flex items-center justify-between text-sm text-slate-600">
                      <span className="capitalize">{entry.label}</span>
                      <span>{percentage}%</span>
                    </div>
                    <div className="h-2 rounded-full bg-slate-100">
                      <div
                        className={cn("h-full rounded-full transition-all", entry.color)}
                        style={{ width: `${percentage}%` }}
                      />
                    </div>
                  </div>
                );
              })}
            </CardContent>
          </Card>
        </div>
      </div>

      <Dialog open={Boolean(selectedReview)} onOpenChange={(open) => !open && closeResponseDialog()}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Responder comentario</DialogTitle>
            <DialogDescription>
              Tu respuesta será visible para {selectedReview?.customer_name}.
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            <div className="rounded-lg bg-slate-50 p-4 text-sm text-slate-700">
              <p className="font-semibold text-slate-900">{selectedReview?.customer_name}</p>
              <p className="mt-2 text-slate-600">{selectedReview?.comment}</p>
            </div>
            <Textarea
              value={responseText}
              onChange={(e) => setResponseText(e.target.value)}
              placeholder="Gracias por tu comentario..."
              rows={4}
            />
          </div>
          <DialogFooter className="gap-2">
            <Button variant="outline" onClick={closeResponseDialog}>
              Cancelar
            </Button>
            <Button onClick={handleSubmitResponse} disabled={isSubmittingResponse}>
              {isSubmittingResponse && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              Enviar respuesta
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}
